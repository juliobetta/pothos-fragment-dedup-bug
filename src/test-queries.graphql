# ========================================================================
# POTHOS RELATION BATCHING BUG - REAL WORLD SCENARIO
# ========================================================================
#
# Based on real query pattern from production:
#
# When multiple fragments share the SAME alias (e.g. "yearlyMetrics") with
# the SAME filter arguments, Pothos's dataloader batches the relation loads
# across all parent objects (properties) in a suboptimal way:
#
# BUGGY: Extracts specific (property_id, end_date) pairs as OR conditions:
#   WHERE (property_id = $1 AND end_date = $2) OR (property_id = $3 AND end_date = $4)...
#
# OPTIMAL: Should use range filter with IN clause:
#   WHERE end_date >= $1 AND end_date <= $2 AND property_id IN ($3, $4, ...)
#
# Or even better, lateral joins with filter pushdown:
#   LEFT JOIN LATERAL (SELECT ... WHERE end_date >= $1 AND end_date <= $2)
# ========================================================================

# Simulates the real query: multiple fragments using "yearlyMetrics" alias
# with the same filter arguments across multiple properties
query AccountTrendsQuery(
  $startDate: DateTime!
  $endDate: DateTime!
  $month: Int!
) {
  properties(first: 10) {
    edges {
      node {
        id
        name
        # Main query metrics (single date)
        metrics(first: 10, endDate: $endDate) {
          edges {
            node {
              endDate
              electricity
            }
          }
        }
        # These fragments share "yearlyMetrics" alias with same filter
        ...ElectricityChart_property
        ...GreenPowerChart_property
      }
    }
  }
}

# Fragment 1: Uses yearlyMetrics alias
fragment ElectricityChart_property on Property {
  yearlyMetrics: metrics(first: 50, startDate: $startDate, endDate: $endDate, month: $month) {
    edges {
      node {
        endDate
        month
        electricity
        greenPowerOnsite
      }
    }
  }
}

# Fragment 2: ALSO uses yearlyMetrics alias with SAME filter
# This is the problematic pattern - same alias, same args, but
# Pothos batches the underlying Prisma query suboptimally
fragment GreenPowerChart_property on Property {
  yearlyMetrics: metrics(first: 50, startDate: $startDate, endDate: $endDate, month: $month) {
    edges {
      node {
        endDate
        month
        greenPowerOnsite
        greenPowerOffsite
      }
    }
  }
}

# Variables:
# {
#   "startDate": "2021-01-01",
#   "endDate": "2024-11-30",
#   "month": 11
# }

# ========================================================================
# When this query runs across many properties, instead of generating:
#   SELECT ... WHERE end_date >= '2021-01-01' AND end_date <= '2024-11-30'
#                AND month = 11 AND property_id IN (p1, p2, p3, ...)
#
# Pothos generates:
#   SELECT ... WHERE (property_id = p1 AND end_date = '2021-11-30')
#                 OR (property_id = p1 AND end_date = '2022-11-30')
#                 OR (property_id = p1 AND end_date = '2023-11-30')
#                 OR (property_id = p2 AND end_date = '2021-11-30')
#                 ... (N properties × M years = many OR conditions!)
#
# This is inefficient because:
# 1. No filter pushdown - database can't optimize the range query
# 2. Query size grows with data volume (O(properties × years))
# 3. Lost opportunity for index utilization on date ranges
# ========================================================================
